<!DOCTYPE HTML>
<html>
  <head>
    <title>Crypto</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script>
      var charReg = /[a-zA-Z]/;

      function setup() {
        var id = getURLParameter('id');
        var guess = [];

        function refresh(data) {
          if(data.checksLeft >= 0) {
            setCheckButton(data.checksLeft);
          }
          if(data.guess && (data.guess !== guess)) {
            $('input.letterBox').each(function(index) {
              if(data.guess[this.id]!==" " && data.guess[this.id]!==this.value) {
                this.value = data.guess[this.id];
              }
            });
          }
          if(data.matched) {
            setCorrectLetters(data.matched);
          }
        }

        function poll() {
          $.get('/message?id='+id,function(data) {
            if(data.expired) {
              expirePage();
            } else if(data) {
              refresh(data);
            }
          });
        }

        function expirePage() {
          location.reload();
        }

        function fluffArray(array) {
          for(var i=0;i<array.length;i++) {
            if(!array[i]) {
              array[i] = ' ';
            }
          }
          return array;
        }

        function postGuess() {
          guess = fluffArray(guess);
          $.post("/guess",{'id': id , 'guess': guess});
        }

        function setCheckButton(checksLeft) {
          if(checksLeft === 0) {
              $('#checkButton').val('Burn');
              $('#checkButton').addClass('burn');
            } else {
              $('#checkButton').val(checksLeft + ' Checks Left');
            }
        }

        function setCorrectLetters(matched) {
          for(var i=0;i<matched.length;i++) {
            if(matched[i]) {
              var selector = '#'+i;
              $(selector).addClass('correct');
              $(selector).attr('disabled','disabled');
            }
          }
        }

        $('#messageForm').submit(function() {
          if(!guess) {
            return false;
          }
          guess = fluffArray(guess);
          $.post("/check",{'id': id, 'guess': guess}, function(data) {
            if(data.matched) {
              setCorrectLetters(data.matched);
            }
            if(data.checksLeft >= 0) {
              setCheckButton(data.checksLeft);
            }
            if(data.expired) {
              expirePage();
            }
          });
          return false;
        });

        $.get('/message?id='+id,function(data) {
          var message = $('#encryptedMessage');
          if(data && !data.expired) {
            if(data.guess) {
              guess = data.guess;
            } else {
              guess = new Array(data.encryptedText.length);
            }
            var tableCols = 24;
            var text = data.encryptedText;
            var tableRows = Math.ceil(text.length/tableCols);
            var tableString = '';
            tableString += '<table><tbody>';
            for(var r=0;r<tableRows;r++) {
              tableString += '<tr>';
              for(var c=0;c<tableCols;c++) {
                tableString += '<td class="letterBox">';
                var letterIndex = r*tableCols+c;
                var letter = text[letterIndex]? text[letterIndex] : ' ';
                if(charReg.test(letter)) {
                  var guessLetter = (guess[letterIndex]&&(guess[letterIndex]!==' '))?guess[letterIndex]:'';
                  var boxIndex = letterIndex;
                  tableString += '<input class="letterBox letter'+letter+'" name="'+letter+'" maxlength="1" id="'+boxIndex+'" value="'+guessLetter+'">';
                } else {
                  tableString += letter;
                }
                tableString += '</td>';
              }
              tableString += '</tr><tr>';
              for(var c=0;c<tableCols;c++) {
                tableString += '<td class="letterBox">';
                var letterIndex = r*tableCols+c;
                var letter = text[letterIndex]? text[letterIndex] : ' ';
                tableString += letter;
                tableString += '</td>';
              }
              tableString += '</tr><tr><td>&nbsp;</td></tr>';
            }
            tableString += '</tbody></table>';
            message.append(tableString);
            $('#hint').html(data.hint);
            $('#formDiv').css('display','block');
            $('input.letterBox').keyup(function(e) {
              switch(e.which) {
                  case 37:
                    var prevBox = $('#'+(parseInt(this.id)-1));
                    if(prevBox) {
                      prevBox.focus();
                    }
                    break;
                  case 39:
                    var nextBox = $('#'+(parseInt(this.id)+1));
                    if(nextBox) {
                      nextBox.focus();
                    }
                    break;
                  default:
                    var identifier = 'input.letter'+this.name;
                    var l = this.value;
                    $(identifier).each(function(index) {
                      this.value = l;
                      guess[this.id] = this.value;
                    });
                    postGuess();
                }
            });
            refresh(data);
            setInterval(poll,3000);
          } else {
            message.html('message expired');
          }
        });
      }

      function getURLParameter(name) {
        return decodeURI(
        (RegExp(
          name + '=' + '(.+?)(&|$)').exec(location.search)||[,null])[1]);
      }

      $(document).ready(setup);
    </script>
  </head>
  <body>
    <div class='content'>
    	<h1>Message</h1>
    	<p>
        <div id='encryptedMessage' class='message'></div>
        <div id='formDiv' style='display:none'>
          <br>
          <div id='hint' class='hint'></div>
    		  <form id='messageForm'><input id='checkButton' type='submit' class='submit' value='Check'></form>
        </div>
    	</p>
    </div>
  </body>
</html>